<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>LinguaLink — Real-time Translated Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <style>
        html, body { height: 100%; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255,255,255,0.08); backdrop-filter: blur(8px); }
        .nice-scroll::-webkit-scrollbar{width:8px;height:8px}
        .nice-scroll::-webkit-scrollbar-track{background:transparent}
        .nice-scroll::-webkit-scrollbar-thumb{background:#ffffff22;border-radius:8px}
        .nice-scroll:hover::-webkit-scrollbar-thumb{background:#ffffff3f}
        
        .bubble {
            position: relative;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            max-width: 100%; /* Changed from 80% to allow wrapper to control width */
        }
        .bubble:after { content:""; position:absolute; bottom:-2px; width:10px; height:10px; transform:rotate(45deg); }
        
        .bubble.me {
            background:#5b7cff;
            border-bottom-right-radius: 0.25rem;
        }
        .bubble.them {
            background:#111827; /* Changed from chocolate */
            border-bottom-left-radius: 0.25rem;
        }
        .bubble.me:after { right:12px; background:#5b7cff; }
        .bubble.them:after { left:12px; background:#111827; }

        input[type="file"] { display: none; }
        emoji-picker { position: absolute; bottom: 100%; left: 0; margin-bottom: 8px; z-index: 50; }
        
        /* Reactions Styles */
        .message-wrapper { position: relative; display: flex; flex-direction: column; }
        .message-wrapper.mine { align-items: flex-end; }
        .message-wrapper.theirs { align-items: flex-start; }
        .reaction-button { position: absolute; top: 50%; transform: translateY(-50%); z-index: 10; opacity: 0; transition: opacity 0.2s; }
        
        /* MODIFIED: Adjust reaction button position based on avatar */
        .message-wrapper:hover .reaction-button { opacity: 1; }
        .mine .reaction-button { right: -1.8rem; }
        .theirs .reaction-button { left: -1.8rem; }

        .reaction-picker { position: absolute; display: flex; gap: 4px; background: #2a314b; padding: 6px; border-radius: 99px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 20; top: -40px; }
        .mine .reaction-picker { right: 0; }
        .theirs .reaction-picker { left: 0; }
        .reaction-picker span { cursor: pointer; font-size: 1.25rem; transition: transform 0.1s; }
        .reaction-picker span:hover { transform: scale(1.2); }
        
        .reactions-display { display: flex; gap: 4px; margin-top: 6px; }
        .mine .reactions-display { justify-content: flex-end; }
        .theirs .reactions-display { justify-content: flex-start; }
        .reaction-chip { display: flex; items-center: center; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 99px; font-size: 0.75rem; cursor: pointer; }
        .reaction-chip.reacted-by-me { background: #5b7cff; border: 1px solid rgba(255,255,255,0.5); }
        .reaction-chip span { margin-left: 4px; font-weight: 500; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-900 via-slate-900 to-black text-white antialiased">

    <div id="app-shell" class="hidden h-screen w-screen flex items-center justify-center p-4">
        <div id="login-screen" class="hidden w-full max-w-md text-center">
             <div class="glass rounded-2xl border border-white/10 p-8 shadow-2xl">
                <div class="h-16 w-16 mx-auto rounded-xl bg-gradient-to-br from-indigo-400 to-fuchsia-500 grid place-items-center font-bold text-2xl">LL</div>
                <h1 class="text-3xl font-bold text-white mt-4">Welcome to LinguaLink</h1>
                <p class="text-white/60 mt-2">Secure, Real-time, Translated Chat.</p>
                <div class="mt-8">
                    <a href="/auth/google/signin" class="inline-flex items-center justify-center gap-3 w-full max-w-xs mx-auto bg-white/90 text-slate-800 font-medium py-3 px-4 rounded-lg shadow-md hover:bg-white transition">
                        <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3c-1.3 5.5-6.1 9.5-11.3 9.5-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.8 1.2 7.9 3.2l5.8-5.8C34.4 6.6 29.6 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 20-9 20-20 0-1.1-.1-2.2-.4-3.5z"/></svg>
                        <span>Sign in with Google</span>
                    </a>
                </div>
            </div>
        </div>
        
        <div id="chat-screen" class="hidden h-full w-full max-w-7xl">
            <div class="grid lg:grid-cols-[360px,1fr] gap-6 h-full">
                <aside class="glass rounded-2xl border border-white/10 p-4 lg:p-5 flex flex-col">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="relative"><img id="my-avatar" class="h-10 w-10 rounded-xl object-cover bg-gradient-to-br from-indigo-400 to-fuchsia-500"><div id="my-status-dot" class="absolute -bottom-0.5 -right-0.5 h-3 w-3 bg-green-500 rounded-full border-2 border-slate-800"></div></div>
                            <div><h1 id="my-name" class="text-lg font-semibold"></h1><p class="text-xs text-white/60">Online</p></div>
                        </div>
                        <button id="btnLogout" title="Logout" class="inline-flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/15 active:bg-white/20 transition p-2 text-sm"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button>
                    </div>

                    <div class="mt-4">
                        <div class="relative"><input id="searchInput" type="text" placeholder="Search chats..." class="w-full rounded-xl bg-white/5 border border-white/10 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 placeholder-white/40"><svg class="absolute right-3 top-1/2 -translate-y-1/2 opacity-60" width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="white" stroke-opacity=".7" stroke-width="1.5"/><path d="M20 20L17 17" stroke="white" stroke-opacity=".7" stroke-width="1.5" stroke-linecap="round"/></svg></div>
                        <details class="mt-3"><summary class="cursor-pointer text-sm text-indigo-300 hover:text-indigo-200">+ Start new chat by email</summary><form id="addContactForm" class="mt-2 space-y-2"><input id="contactEmail" type="email" placeholder="friend@email.com" required class="w-full rounded-xl bg-white/5 border border-white/10 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 placeholder-white/40"><button type="submit" class="w-full rounded-xl bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 transition px-4 py-2.5 text-sm font-medium">Find & Connect</button></form></details>
                    </div>

                    <div class="mt-4 flex-1 overflow-y-auto nice-scroll" id="chatList"></div>
                </aside>

                <section id="main-chat-area" class="glass rounded-2xl border border-white/10 flex flex-col overflow-hidden opacity-50 pointer-events-none">
                    <div class="px-4 lg:px-6 py-4 border-b border-white/10 flex items-center justify-between">
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="relative"><div id="contact-avatar-wrapper" class="h-10 w-10 rounded-xl bg-gray-700 grid place-items-center font-bold"></div><div id="contact-status-dot" class="absolute -bottom-0.5 -right-0.5 h-3 w-3 bg-gray-500 rounded-full border-2 border-slate-800"></div></div>
                            <div class="min-w-0"><h2 id="contact-name" class="font-semibold truncate">Select a chat</h2><p id="contact-status" class="text-xs text-white/60">Offline</p></div>
                        </div>
                        <div class="flex items-center gap-2"><label class="text-xs text-white/70">My language</label><select id="langSelect" class="rounded-lg bg-white/5 border border-white/10 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50"><option value="en">English</option><option value="hi">हिन्दी (Hindi)</option><option value="es">Español</option><option value="fr">Français</option><option value="de">Deutsch</option></select></div>
                    </div>

                    <ul id="messages" class="flex-1 overflow-y-auto nice-scroll p-4 lg:p-6 space-y-4 min-h-0"></ul>

                    <form id="composer" class="p-3 lg:p-4 border-t border-white/10">
                        <div class="flex items-end gap-2">
                            <div class="flex items-center gap-1">
                                 <div class="relative">
                                    <button id="emojiBtn" type="button" class="p-2 rounded-full hover:bg-white/10 transition"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg></button>
                                    <emoji-picker class="hidden"></emoji-picker>
                                </div>
                                <label for="fileInput" class="p-2 rounded-full hover:bg-white/10 transition cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg></label>
                                <input type="file" id="fileInput" accept="image/*,audio/*,application/pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt">
                            </div>
                            <div class="flex-1"><textarea id="messageInput" rows="1" placeholder="Type a message..." class="w-full resize-none rounded-xl bg-white/5 border border-white/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 placeholder-white/40"></textarea><div id="upload-progress" class="hidden text-xs text-center text-white/70 mt-1">Uploading...</div></div>
                            <div class="flex items-center"><button type="submit" class="rounded-xl bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 px-4 py-3 font-medium">Send</button></div>
                        </div>
                    </form>
                </section>
            </div>
        </div>
    </div>
    
    <div id="modal" class="hidden fixed inset-0 z-[60] grid place-items-center p-4">
        <div class="absolute inset-0 bg-black/60" id="modal-bg"></div>
        <div class="relative w-full max-w-md glass rounded-2xl border border-white/10 p-5">
            <div id="modalContent"></div>
            <div class="mt-4 flex justify-end"><button id="modalClose" class="rounded-xl bg-white/10 hover:bg-white/15 px-4 py-2">Close</button></div>
        </div>
    </div>

    <script>
    // --- Configuration & State ---
    const API_BASE_URL = window.location.origin;
    const WS_BASE_URL = window.location.origin.replace(/^http/, 'ws');
    let state = { token: null, currentUser: null, chats: [], activeChatId: null, ws: null };
    
    // --- DOM Elements ---
    const el = q => document.querySelector(q);
    const messagesContainer = el('#messages'), messageInput = el('#messageInput'), 
          emojiPicker = el('emoji-picker'), fileInput = el('#fileInput');

    // --- UTILS ---
    const formatTime = iso => new Date(iso).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    function formatLastSeen(iso) {
        if (!iso) return 'Offline';
        const diff = (new Date() - new Date(iso)) / 1000;
        if (diff < 60) return 'last seen just now';
        if (diff < 3600) return `last seen ${Math.round(diff/60)}m ago`;
        if (diff < 86400) return `last seen ${Math.round(diff/3600)}h ago`;
        return 'last seen yesterday';
    }

    // --- MODAL ---
    function showModal(html) { el('#modalContent').innerHTML = html; el('#modal').classList.remove('hidden'); }
    function hideModal() { el('#modal').classList.add('hidden'); }

    // --- AUTH & INIT ---
    function logout() { localStorage.removeItem('lingua_link_token'); window.location.href = '/'; }
    async function initializeApp() {
        if (!state.token) { updateAuthUI(); return; }
        try {
            const res = await fetch(`${API_BASE_URL}/users/me?token=${state.token}`);
            if (res.status === 401) throw new Error('Session expired.');
            state.currentUser = await res.json();
            
            await fetchChats();
            connectWebSocket();
            updateAuthUI();
            renderAll();
        } catch (error) { console.error("Init failed:", error); logout(); }
    }
    async function fetchChats() {
        const res = await fetch(`${API_BASE_URL}/chats?token=${state.token}`);
        state.chats = await res.json();
        state.chats.forEach(c => c.messages = []);
        state.chats.sort((a, b) => new Date(b.last_message_timestamp || 0) - new Date(a.last_message_timestamp || 0));
    }

    // --- WEBSOCKET HANDLING ---
    function connectWebSocket() {
        if (state.ws) state.ws.close();
        state.ws = new WebSocket(`${WS_BASE_URL}/ws?token=${state.token}`);
        state.ws.onmessage = event => {
            const data = JSON.parse(event.data);
            switch (data.type) {
                case 'new_message': handleNewMessage(data); break;
                case 'translations_ready': handleTranslationsReady(data); break;
                case 'presence_update': handlePresenceUpdate(data); break;
                case 'reaction_update': handleReactionUpdate(data); break;
            }
        };
        state.ws.onerror = err => console.error("WS Error:", err);
    }
    function handleNewMessage(msg) {
        const chat = state.chats.find(c => c.id === msg.chat_id);
        if (!chat) return;
        chat.last_message_content = msg.message_type === 'text' ? msg.original_content : `[${msg.message_type}]`;
        chat.last_message_timestamp = msg.created_at;
        chat.last_message_type = msg.message_type;
        if (!chat.messages.some(m => m.id === msg.id)) chat.messages.push(msg);
        if (chat.id === state.activeChatId) renderMessages();
        state.chats.sort((a, b) => new Date(b.last_message_timestamp || 0) - new Date(a.last_message_timestamp || 0));
        renderChatList();
    }
    function handleTranslationsReady(data) {
        const msg = findMessage(data.chat_id, data.id);
        if (msg) {
            msg.translations = data.translations;
            if (data.chat_id === state.activeChatId) updateMessageDOM(msg);
        }
    }
    function handlePresenceUpdate(data) {
        state.chats.forEach(chat => {
            const p = chat.participants.find(p => p.id === data.user_id);
            if (p) { p.is_online = data.is_online; p.last_seen = data.last_seen; }
        });
        renderChatList();
        if (state.activeChatId && state.chats.find(c => c.id === state.activeChatId).participants.some(p => p.id === data.user_id)) renderHeader();
    }
    function handleReactionUpdate(data) {
        const msg = findMessage(data.chat_id, data.message_id);
        if (msg) {
            msg.reactions = data.reactions;
            if (data.chat_id === state.activeChatId) updateMessageDOM(msg);
        }
    }
    function findMessage(chatId, messageId) {
        const chat = state.chats.find(c => c.id === chatId);
        return chat ? chat.messages.find(m => m.id === messageId) : null;
    }

    // --- UI & RENDERING ---
    async function selectChat(chatId) {
        if (!chatId || state.activeChatId === chatId) return;
        state.activeChatId = chatId;
        
        el('#main-chat-area').classList.remove('opacity-50', 'pointer-events-none');
        messagesContainer.innerHTML = '<div class="text-white/50 text-center text-sm">Loading...</div>';
        renderHeader();
        
        try {
            const res = await fetch(`${API_BASE_URL}/chats/${chatId}/messages?token=${state.token}`);
            if (!res.ok) throw new Error('Failed to load messages.');
            const chat = state.chats.find(c => c.id === chatId);
            if(chat) chat.messages = await res.json();
            renderMessages();
        } catch (error) { messagesContainer.innerHTML = `<div class="text-rose-400 text-center text-sm">${error.message}</div>`; }
        renderChatList();
    }
    function renderAll() { if (state.currentUser) { renderMyProfile(); renderChatList(); renderHeader(); } }
    function updateAuthUI() {
        const showChat = state.token && state.currentUser;
        el('#login-screen').classList.toggle('hidden', showChat);
        el('#chat-screen').classList.toggle('hidden', !showChat);
        el('#app-shell').classList.remove('hidden');
    }
    function renderMyProfile() {
        el('#my-name').textContent = state.currentUser.name;
        el('#my-avatar').src = state.currentUser.picture || '';
        el('#langSelect').value = state.currentUser.default_language || 'en';
    }
    function renderChatList() {
        const listEl = el('#chatList');
        listEl.innerHTML = '';
        const query = el('#searchInput').value.trim().toLowerCase();
        state.chats.filter(c => {
            const p = c.participants.find(p => p.id !== state.currentUser.id);
            return !query || (p && p.name.toLowerCase().includes(query));
        }).forEach(c => {
            const p = c.participants.find(p => p.id !== state.currentUser.id);
            if (!p) return;
            let content = c.last_message_type === 'text' ? (c.last_message_content || '') : `[${c.last_message_type}]`;
            const item = document.createElement('div');
            item.className = `rounded-xl p-3 hover:bg-white/5 cursor-pointer transition border border-transparent ${c.id === state.activeChatId ? 'bg-white/5 border-white/10' : ''}`;
            item.onclick = () => selectChat(c.id);
            item.innerHTML = `<div class="flex items-center gap-3"><div class="relative"><img src="${p.picture}" class="h-10 w-10 rounded-xl bg-gray-700 object-cover"><div class="absolute -bottom-0.5 -right-0.5 h-3 w-3 ${p.is_online ? 'bg-green-500' : 'bg-gray-500'} rounded-full border-2 border-slate-800"></div></div><div class="min-w-0 flex-1"><div class="flex items-center justify-between gap-2"><p class="font-medium truncate">${p.name}</p><span class="text-[11px] text-white/50">${c.last_message_timestamp ? formatTime(c.last_message_timestamp) : ''}</span></div><p class="text-sm text-white/60 truncate">${content}</p></div></div>`;
            listEl.appendChild(item);
        });
    }
    function renderHeader() {
        const chat = state.chats.find(c => c.id === state.activeChatId);
        const p = chat ? chat.participants.find(p => p.id !== state.currentUser.id) : null;
        el('#contact-name').textContent = p ? p.name : 'Select a chat';
        el('#contact-avatar-wrapper').innerHTML = p ? `<img src="${p.picture}" class="h-10 w-10 rounded-xl object-cover">` : '';
        el('#contact-status-dot').className = `absolute -bottom-0.5 -right-0.5 h-3 w-3 ${p && p.is_online ? 'bg-green-500' : 'bg-gray-500'} rounded-full border-2 border-slate-800`;
        el('#contact-status').textContent = p ? (p.is_online ? 'Online' : formatLastSeen(p.last_seen)) : 'Offline';
    }
    function renderMessages() {
        messagesContainer.innerHTML = '';
        const chat = state.chats.find(c => c.id === state.activeChatId);
        if (!chat || !chat.messages?.length) {
            messagesContainer.innerHTML = '<div class="text-white/50 text-center text-sm">Send a message to start!</div>'; return;
        }
        chat.messages.forEach(msg => messagesContainer.appendChild(createMessageDOM(msg)));
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // MODIFIED: Renders a single message with avatar
    function createMessageDOM(msg) {
        const mine = msg.sender_id === state.currentUser.id;
        const chat = state.chats.find(c => c.id === state.activeChatId);
        const sender = chat ? chat.participants.find(p => p.id === msg.sender_id) : { name: 'User', picture: '' };
        const senderPicture = msg.sender_picture || sender.picture; // Use sender_picture from WS if available

        const li = document.createElement('li');
        li.id = `msg-${msg.id}`;
        li.className = `message-container flex items-start gap-3 max-w-[85%] ${mine ? 'flex-row-reverse ml-auto' : 'mr-auto'}`;

        li.innerHTML = `
            <img src="${senderPicture}" alt="${sender.name}" class="h-8 w-8 rounded-full object-cover mt-1 flex-shrink-0">
            <div class="flex-1 relative">
                <div class="message-wrapper ${mine ? 'mine' : 'theirs'}">
                    <div class="bubble ${mine ? 'me' : 'them'}">
                        ${!mine ? `<div class="font-bold text-sm mb-1 text-indigo-300">${sender.name}</div>` : ''}
                        ${renderMessageContent(msg)}
                        ${renderMessageMeta(msg)}
                    </div>
                    <div class="reactions-display"></div>
                </div>
                <button class="reaction-button p-1 rounded-full bg-slate-700 hover:bg-slate-600">
                     <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                </button>
                <div class="reaction-picker hidden">
                    ${['👍', '❤️', '😂', '😯', '😢', '🙏'].map(emoji => `<span>${emoji}</span>`).join('')}
                </div>
            </div>
        `;
        li.querySelector('.reactions-display').innerHTML = renderReactions(msg);
        return li;
    }
    
    // MODIFIED: Re-renders the message to update it
    function updateMessageDOM(msg) {
        const oldMsgElement = document.getElementById(`msg-${msg.id}`);
        if (oldMsgElement) {
            const newMsgElement = createMessageDOM(msg);
            oldMsgElement.parentNode.replaceChild(newMsgElement, oldMsgElement);
        }
    }

    function renderMessageContent(msg) {
        switch(msg.message_type) {
            case 'image': return `<a href="${API_BASE_URL}${msg.file_url}" target="_blank"><img src="${API_BASE_URL}${msg.file_url}" class="rounded-lg max-w-xs max-h-64 object-cover"></a>`;
            case 'audio': return `<audio controls class="w-full max-w-xs" src="${API_BASE_URL}${msg.file_url}"></audio>`;
            case 'file': return `<a href="${API_BASE_URL}${msg.file_url}" target="_blank" class="flex items-center gap-3 bg-white/5 p-3 rounded-lg hover:bg-white/10"><svg class="h-8 w-8" viewBox="0 0 24 24"><path fill="currentColor" d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline fill="none" stroke="currentColor" points="13 2 13 9 20 9"></polyline></svg><span>${msg.original_content}</span></a>`;
            default:
                const myLang = state.currentUser.default_language || 'en';
                const displayText = (msg.translations && msg.translations[myLang]) || msg.original_content;
                return `<div class="whitespace-pre-wrap break-words">${displayText}</div>`;
        }
    }
    function renderMessageMeta(msg) {
        const myLang = state.currentUser.default_language || 'en';
        const hasTranslation = msg.translations && msg.translations[myLang] && Object.keys(msg.translations).length > 1;
        return `<div class="flex items-center gap-2 mt-1 text-[11px] text-white/60">
            <span>${formatTime(msg.created_at)}</span>
            ${msg.message_type === 'text' && hasTranslation ? `<button class="underline toggle-translation">Show original</button>` : ''}
        </div>`;
    }
    function renderReactions(msg) {
        if (!msg.reactions || Object.keys(msg.reactions).length === 0) return '';
        return Object.entries(msg.reactions).map(([emoji, userIds]) => {
            const reactedByMe = userIds.includes(state.currentUser.id);
            return `<div class="reaction-chip ${reactedByMe ? 'reacted-by-me' : ''}" data-emoji="${emoji}">
                ${emoji} <span>${userIds.length}</span>
            </div>`;
        }).join('');
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('click', e => {
        if (!e.target.closest('.reaction-button') && !e.target.closest('.reaction-picker')) {
            document.querySelectorAll('.reaction-picker').forEach(p => p.classList.add('hidden'));
        }
    });
    messagesContainer.addEventListener('click', e => {
        const msgContainer = e.target.closest('.message-container');
        if (!msgContainer) return;
        const msgId = msgContainer.id.replace('msg-', '');

        if (e.target.closest('.reaction-button')) {
            msgContainer.querySelector('.reaction-picker').classList.toggle('hidden');
        } else if (e.target.closest('.reaction-picker span')) {
            const emoji = e.target.textContent;
            sendReaction(msgId, emoji);
            msgContainer.querySelector('.reaction-picker').classList.add('hidden');
        } else if (e.target.closest('.reaction-chip')) {
            const emoji = e.target.closest('.reaction-chip').dataset.emoji;
            sendReaction(msgId, emoji);
        } else if (e.target.closest('.toggle-translation')) {
            const msg = findMessage(state.activeChatId, msgId);
            if (!msg) return;
            const textEl = msgContainer.querySelector('.bubble > div:first-child > div');
            const myLang = state.currentUser.default_language || 'en';
            const translatedText = msg.translations[myLang];
            const originalText = msg.original_content;
            
            if (textEl.textContent === translatedText) {
                textEl.textContent = originalText;
                e.target.textContent = 'Show translated';
            } else {
                textEl.textContent = translatedText;
                e.target.textContent = 'Show original';
            }
        }
    });
    function sendReaction(message_id, emoji) {
        if (!state.ws || state.ws.readyState !== WebSocket.OPEN) return;
        state.ws.send(JSON.stringify({
            type: 'reaction', chat_id: state.activeChatId, message_id, emoji
        }));
    }

    el('#composer').addEventListener('submit', e => {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (!content) return;
        state.ws.send(JSON.stringify({
            type: 'message', chat_id: state.activeChatId, message_type: 'text', content
        }));
        messageInput.value = ''; messageInput.style.height = 'auto'; emojiPicker.classList.add('hidden');
    });
    fileInput.addEventListener('change', async e => {
        const file = e.target.files[0];
        if (!file || !state.activeChatId) return;
        el('#upload-progress').classList.remove('hidden');
        const formData = new FormData(); formData.append('file', file);
        try {
            const res = await fetch(`${API_BASE_URL}/uploads?token=${state.token}`, { method: 'POST', body: formData });
            if (!res.ok) throw new Error('Upload failed.');
            const { file_url } = await res.json();
            let message_type = file.type.startsWith('image/') ? 'image' : (file.type.startsWith('audio/') ? 'audio' : 'file');
            state.ws.send(JSON.stringify({
                type: 'message', chat_id: state.activeChatId, message_type,
                file_url, original_content: file.name
            }));
        } catch (error) { showModal(`<h4>Upload Error</h4><p>${error.message}</p>`); } 
        finally { el('#upload-progress').classList.add('hidden'); fileInput.value = ''; }
    });

    el('#btnLogout').addEventListener('click', logout);
    el('#searchInput').addEventListener('input', renderChatList);
    el('#modalClose, #modal-bg').addEventListener('click', hideModal);
    el('#emojiBtn').addEventListener('click', () => emojiPicker.classList.toggle('hidden'));
    emojiPicker.addEventListener('emoji-click', e => { messageInput.value += e.detail.unicode; });
    el('#addContactForm').addEventListener('submit', async e => {
        e.preventDefault();
        const email = el('#contactEmail').value.trim(); if (!email) return;
        try {
            const res = await fetch(`${API_BASE_URL}/chats?participant_email=${email}&token=${state.token}`, { method: 'POST' });
            if (!res.ok) { const err = await res.json(); throw new Error(err.detail); }
            const newChat = await res.json();
            el('#contactEmail').value = ''; e.target.closest('details').removeAttribute('open');
            await fetchChats(); selectChat(newChat.id);
        } catch(error) { showModal(`<h4>Error</h4><p>${error.message}</p>`); }
    });
    el('#langSelect').addEventListener('change', async e => {
        state.currentUser.default_language = e.target.value;
        await fetch(`${API_BASE_URL}/users/me?token=${state.token}`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ default_language: e.target.value }),
        });
        renderMessages();
    });
    messageInput.addEventListener('input', () => {
        messageInput.style.height = 'auto';
        messageInput.style.height = `${Math.min(160, messageInput.scrollHeight)}px`;
    });

    // --- App Start ---
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        state.token = urlParams.get('token') || localStorage.getItem('lingua_link_token');
        if (urlParams.has('token')) {
            localStorage.setItem('lingua_link_token', state.token);
            window.history.replaceState({}, document.title, "/");
        }
        initializeApp();
    };
    </script>
</body>
</html>