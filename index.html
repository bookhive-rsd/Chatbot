<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>LinguaLink — Real-time Translated Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { height: 100%; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255,255,255,0.08); backdrop-filter: blur(8px); }
        .nice-scroll::-webkit-scrollbar{width:8px;}
        .nice-scroll::-webkit-scrollbar-track{background:transparent}
        .nice-scroll::-webkit-scrollbar-thumb{background:#ffffff22;border-radius:8px}
        .bubble:after { content:""; position:absolute; bottom:-2px; width:10px; height:10px; transform:rotate(45deg); }
        .bubble.me:after { right:12px; background:#5b7cff; }
        .bubble.them:after { left:12px; background:#111827; }
        .avatar-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 9999px;
            border: 2px solid #1f2937; /* Matches aside background */
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-900 via-slate-900 to-black text-white antialiased">

    <div id="app-shell" class="hidden h-screen w-screen flex items-center justify-center p-4">

        <!-- Login Screen -->
        <div id="login-screen" class="hidden w-full max-w-md text-center">
            <div class="glass rounded-2xl border border-white/10 p-8 shadow-2xl">
                <div class="h-16 w-16 mx-auto rounded-xl bg-gradient-to-br from-indigo-400 to-fuchsia-500 grid place-items-center font-bold text-2xl">LL</div>
                <h1 class="text-3xl font-bold text-white mt-4">Welcome to LinguaLink</h1>
                <p class="text-white/60 mt-2">Secure, Real-time, Translated Chat.</p>
                <div class="mt-8">
                    <a href="/auth/google/signin"
                       class="inline-flex items-center justify-center gap-3 w-full max-w-xs mx-auto bg-white/90 text-slate-800 font-medium py-3 px-4 rounded-lg shadow-md hover:bg-white transition">
                        <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3c-1.3 5.5-6.1 9.5-11.3 9.5-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.8 1.2 7.9 3.2l5.8-5.8C34.4 6.6 29.6 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 20-9 20-20 0-1.1-.1-2.2-.4-3.5z"/></svg>
                        <span>Sign in with Google</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Main Chat UI -->
        <div id="chat-screen" class="hidden h-full w-full max-w-7xl">
            <div class="grid lg:grid-cols-[360px,1fr] gap-6 h-full">
                <!-- Sidebar -->
                <aside class="glass rounded-2xl border border-white/10 p-4 lg:p-5 flex flex-col bg-[#1f2937]/50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <img id="my-avatar" src="" class="h-10 w-10 rounded-xl object-cover bg-gradient-to-br from-indigo-400 to-fuchsia-500">
                                <div class="avatar-indicator bg-green-500"></div>
                            </div>
                            <div>
                                <h1 id="my-name" class="text-lg font-semibold"></h1>
                                <p class="text-xs text-white/60">Online</p>
                            </div>
                        </div>
                        <button id="btnLogout" title="Logout" class="rounded-xl bg-white/10 hover:bg-white/15 p-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
                    </div>
                    <div class="mt-4"><input id="searchInput" type="text" placeholder="Search chats..." class="w-full rounded-xl bg-white/5 border border-white/10 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500/50"></div>
                    <details class="mt-3"><summary class="cursor-pointer text-sm text-indigo-300 hover:text-indigo-200">+ Start new chat</summary><form id="addContactForm" class="mt-2 space-y-2"><input id="contactEmail" type="email" placeholder="friend@email.com" required class="w-full rounded-xl bg-white/5 border border-white/10 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500/50"><button type="submit" class="w-full rounded-xl bg-indigo-600 hover:bg-indigo-500 px-4 py-2.5 text-sm font-medium">Find & Connect</button></form></details>
                    <div class="mt-4 flex-1 overflow-y-auto nice-scroll" id="chatList"></div>
                </aside>

                <!-- Main area -->
                <section id="main-chat-area" class="glass rounded-2xl border border-white/10 flex flex-col h-full opacity-50 pointer-events-none">
                    <div class="px-4 lg:px-6 py-4 border-b border-white/10 flex items-center justify-between"><div class="flex items-center gap-3 min-w-0"><div id="contact-avatar-wrapper" class="relative"><div id="contact-avatar" class="h-10 w-10 rounded-xl bg-gray-700"></div><div id="contact-avatar-indicator" class="avatar-indicator bg-gray-500"></div></div><div class="min-w-0"><h2 id="contact-name" class="font-semibold truncate">Select a chat</h2><p id="contact-status" class="text-xs text-white/60">Offline</p></div></div><div class="flex items-center gap-2"><label class="text-xs text-white/70">My language</label><select id="langSelect" class="rounded-lg bg-white/5 border border-white/10 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50"><option value="en">English</option><option value="hi">हिन्दी (Hindi)</option><option value="es">Español</option><option value="fr">Français</option><option value="de">Deutsch</option></select></div></div>
                    <div id="messages" class="flex-1 overflow-y-auto nice-scroll p-4 lg:p-6 space-y-3"><div class="text-white/50 text-center text-sm">Pick a chat from the left to get started.</div></div>
                    <form id="composer" class="p-3 lg:p-4 border-t border-white/10"><div class="flex items-end gap-2"><textarea id="messageInput" rows="1" placeholder="Type a message..." class="flex-1 w-full resize-none rounded-xl bg-white/5 border border-white/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500/50"></textarea><button type="submit" class="rounded-xl bg-indigo-600 hover:bg-indigo-500 px-4 py-3 font-medium">Send</button></div></form>
                </section>
            </div>
        </div>

    </div>
    
    <div id="modal" class="hidden fixed inset-0 z-[60] grid place-items-center p-4"><div class="absolute inset-0 bg-black/60" id="modal-bg"></div><div class="relative w-full max-w-md glass rounded-2xl border border-white/10 p-5"><div id="modalContent"></div><div class="mt-4 flex justify-end"><button id="modalClose" class="rounded-xl bg-white/10 hover:bg-white/15 px-4 py-2">Close</button></div></div></div>

    <script>
    const API_BASE_URL = 'http://127.0.0.1:3000';
    const WS_BASE_URL = 'ws://127.0.0.1:3000';

    let state = { token: null, currentUser: null, chats: [], activeChatId: null, ws: null };
    
    const el = (q) => document.querySelector(q);

    // --- UTILS ---
    const formatTime = (isoString) => new Date(isoString).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const formatLastSeen = (isoString) => {
        if (!isoString) return 'Offline';
        const now = new Date();
        const lastSeen = new Date(isoString);
        const diffSeconds = Math.round((now - lastSeen) / 1000);
        const diffMinutes = Math.round(diffSeconds / 60);
        const diffHours = Math.round(diffMinutes / 60);
        const diffDays = Math.round(diffHours / 24);

        if (diffSeconds < 60) return `last seen just now`;
        if (diffMinutes < 60) return `last seen ${diffMinutes}m ago`;
        if (diffHours < 24) return `last seen ${diffHours}h ago`;
        if (diffDays === 1) return `last seen yesterday`;
        return `last seen ${diffDays} days ago`;
    };

    // --- MODAL ---
    function showModal(html) { el('#modalContent').innerHTML = html; el('#modal').classList.remove('hidden'); }
    function hideModal() { el('#modal').classList.add('hidden'); }

    // --- AUTH ---
    function logout() {
        localStorage.removeItem('lingua_link_token');
        if (state.ws) state.ws.close();
        window.location.href = '/';
    }

    // --- CORE APP LOGIC ---
    async function initializeApp() {
        if (!state.token) { updateAuthUI(); return; }
        try {
            const res = await fetch(`${API_BASE_URL}/users/me?token=${state.token}`);
            if (res.status === 401) throw new Error('Session expired.');
            state.currentUser = await res.json();
            
            await fetchChats();
            connectWebSocket();
            updateAuthUI();
            renderAll();
        } catch (error) { console.error("Initialization failed:", error); logout(); }
    }

    async function fetchChats() {
        const res = await fetch(`${API_BASE_URL}/chats?token=${state.token}`);
        state.chats = await res.json();
        state.chats.sort((a, b) => new Date(b.last_message_timestamp || 0) - new Date(a.last_message_timestamp || 0));
    }

    async function selectChat(chatId) {
        if (!chatId || chatId === 'undefined') return;
        state.activeChatId = chatId;
        
        el('#main-chat-area').classList.remove('opacity-50', 'pointer-events-none');
        el('#messages').innerHTML = '<div class="text-white/50 text-center text-sm">Loading messages...</div>';
        renderHeader();
        
        try {
            const res = await fetch(`${API_BASE_URL}/chats/${chatId}/messages?token=${state.token}`);
            const messages = await res.json();
            const chat = state.chats.find(c => c.id === chatId);
            if (chat) chat.messages = messages;
            renderMessages();
        } catch (error) { console.error(error); }
        renderChatList();
    }
    
    function connectWebSocket() {
        if (state.ws) state.ws.close();
        if (!state.token) return;

        // The WebSocket connection is now general, not chat-specific
        state.ws = new WebSocket(`${WS_BASE_URL}/ws?token=${state.token}`);

        state.ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            handleWebSocketMessage(message);
        };
        
        state.ws.onclose = () => { setTimeout(connectWebSocket, 5000); }; // Reconnect after 5s
        state.ws.onerror = (error) => { console.error("WebSocket Error:", error); state.ws.close(); };
    }

    function handleWebSocketMessage(msg) {
        switch (msg.type) {
            case 'new_message':
                const chat = state.chats.find(c => c.id === msg.chat_id);
                if (chat) {
                    if (!chat.messages) chat.messages = [];
                    if (!chat.messages.some(m => m.id === msg.id)) {
                        chat.messages.push(msg);
                    }
                    if (chat.id === state.activeChatId) {
                        renderMessages();
                    }
                }
                break;

            case 'translations_ready':
                const chatForTranslation = state.chats.find(c => c.id === state.activeChatId);
                if (chatForTranslation && chatForTranslation.messages) {
                    const msgToUpdate = chatForTranslation.messages.find(m => m.id === msg.id);
                    if (msgToUpdate) {
                        msgToUpdate.translations = msg.translations;
                        renderMessages();
                    }
                }
                break;
            
            case 'presence_update':
                state.chats.forEach(c => {
                    const p = c.participants.find(p => p.id === msg.user_id);
                    if (p) {
                        p.is_online = msg.is_online;
                        p.last_seen = msg.last_seen;
                    }
                });
                renderChatList();
                if (state.activeChatId) {
                    const activeChat = state.chats.find(c => c.id === state.activeChatId);
                    if (activeChat && activeChat.participants.some(p => p.id === msg.user_id)) {
                        renderHeader();
                    }
                }
                break;
        }
    }

    // --- RENDERING ---
    function renderAll() {
        if (!state.currentUser) return;
        renderMyProfile();
        renderChatList();
        renderHeader();
        renderMessages();
    }
    
    function updateAuthUI() {
        const showChat = state.token && state.currentUser;
        el('#chat-screen').classList.toggle('hidden', !showChat);
        el('#login-screen').classList.toggle('hidden', showChat);
        el('#app-shell').classList.remove('hidden');
    }

    function renderMyProfile() {
        el('#my-name').textContent = state.currentUser.name;
        el('#my-avatar').src = state.currentUser.picture || '';
        el('#langSelect').value = state.currentUser.default_language || 'en';
    }

    function renderChatList() {
        const list = el('#chatList');
        const query = el('#searchInput').value.trim().toLowerCase();
        
        const filtered = state.chats.filter(c => {
            const partner = c.participants.find(p => p.id !== state.currentUser.id);
            return !query || (partner && partner.name.toLowerCase().includes(query));
        });

        if (filtered.length === 0) {
            list.innerHTML = `<div class="text-center text-sm text-white/50 p-4">No chats found.</div>`;
            return;
        }
        
        list.innerHTML = filtered.map(c => {
            const partner = c.participants.find(p => p.id !== state.currentUser.id);
            if (!partner) return '';
            
            const lastMsg = c.last_message_content || 'No messages yet';
            const lastTime = c.last_message_timestamp ? formatTime(c.last_message_timestamp) : '';
            const isActive = c.id === state.activeChatId;

            return `
                <div class="rounded-xl p-3 hover:bg-white/5 cursor-pointer transition border ${isActive ? 'bg-white/5 border-white/10' : 'border-transparent'}" onclick="selectChat('${c.id}')">
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <img src="${partner.picture}" class="h-10 w-10 rounded-xl bg-gray-700 object-cover">
                            <div class="avatar-indicator ${partner.is_online ? 'bg-green-500' : 'bg-gray-500'}"></div>
                        </div>
                        <div class="min-w-0 flex-1">
                            <div class="flex items-center justify-between gap-2">
                                <p class="font-medium truncate">${partner.name}</p>
                                <span class="text-[11px] text-white/50">${lastTime}</span>
                            </div>
                            <p class="text-sm text-white/60 truncate">${lastMsg}</p>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function renderHeader() {
        const chat = state.chats.find(c => c.id === state.activeChatId);
        const nameEl = el('#contact-name');
        const avatarEl = el('#contact-avatar');
        const statusEl = el('#contact-status');
        const indicatorEl = el('#contact-avatar-indicator');

        if (!chat) {
            nameEl.textContent = 'Select a chat';
            avatarEl.innerHTML = '';
            statusEl.textContent = 'Offline';
            indicatorEl.className = 'avatar-indicator bg-gray-500';
            return;
        }

        const partner = chat.participants.find(p => p.id !== state.currentUser.id);
        if (partner) {
            nameEl.textContent = partner.name;
            avatarEl.innerHTML = `<img src="${partner.picture}" class="h-10 w-10 rounded-xl object-cover">`;
            statusEl.textContent = partner.is_online ? 'Online' : formatLastSeen(partner.last_seen);
            indicatorEl.className = `avatar-indicator ${partner.is_online ? 'bg-green-500' : 'bg-gray-500'}`;
        }
    }
    
    function renderMessages() {
        const container = el('#messages');
        const chat = state.chats.find(c => c.id === state.activeChatId);
        if (!chat || !chat.messages || chat.messages.length === 0) {
            container.innerHTML = '<div class="text-white/50 text-center text-sm">No messages yet.</div>';
            return;
        }

        container.innerHTML = chat.messages.map(msg => {
            const mine = msg.sender_id === state.currentUser.id;
            const myLang = state.currentUser.default_language || 'en';
            
            const textContent = (msg.translations && msg.translations[myLang]) || msg.original_content;
            const canShowOriginal = msg.translations && Object.keys(msg.translations).length > 0 && msg.translations[myLang] && msg.translations[myLang] !== msg.original_content;
            
            return `
                <div class="flex ${mine ? 'justify-end' : ''}">
                    <div class="relative max-w-[80%] rounded-2xl px-4 py-3 bubble ${mine ? 'ml-auto bg-indigo-500/90 me' : 'bg-gray-900 them'}">
                        <div class="text-[15px] leading-relaxed break-words" data-msg-id="${msg.id}">${textContent}</div>
                        <div class="flex items-center gap-2 mt-1 text-[11px] text-white/60">
                            <span>${formatTime(msg.created_at)}</span>
                            ${canShowOriginal ? `<button class="underline" onclick="toggleTranslation('${msg.id}', '${myLang}')">Show original</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        container.scrollTop = container.scrollHeight;
    }

    function toggleTranslation(msgId, myLang) {
        const textEl = document.querySelector(`[data-msg-id="${msgId}"]`);
        const btn = textEl.nextElementSibling.querySelector('button');
        const chat = state.chats.find(c => c.id === state.activeChatId);
        const msg = chat.messages.find(m => m.id === msgId);
        
        if (textEl.textContent === msg.original_content) {
            textEl.textContent = msg.translations[myLang];
            btn.textContent = 'Show original';
        } else {
            textEl.textContent = msg.original_content;
            btn.textContent = 'Show translated';
        }
    }

    // --- EVENT LISTENERS ---
    el('#btnLogout').addEventListener('click', logout);
    el('#searchInput').addEventListener('input', renderChatList);
    el('#modalClose').addEventListener('click', hideModal);
    el('#modal-bg').addEventListener('click', hideModal);

    el('#addContactForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = el('#contactEmail').value.trim();
        if (!email) return;
        try {
            const res = await fetch(`${API_BASE_URL}/chats?participant_email=${email}&token=${state.token}`, { method: 'POST' });
            if (!res.ok) throw new Error((await res.json()).detail);
            const newChat = await res.json();
            el('#contactEmail').value = '';
            el('#addContactForm').closest('details').removeAttribute('open');
            await fetchChats();
            selectChat(newChat.id);
        } catch(error) { showModal(`<p>${error.message}</p>`); }
    });
    
    el('#langSelect').addEventListener('change', async (e) => {
        state.currentUser.default_language = e.target.value;
        await fetch(`${API_BASE_URL}/users/me?token=${state.token}`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ default_language: e.target.value }),
        });
        renderMessages();
    });

    const msgInput = el('#messageInput');
    el('#composer').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!state.ws || state.ws.readyState !== WebSocket.OPEN || !state.activeChatId) return;
        const content = msgInput.value.trim();
        if (!content) return;
        
        state.ws.send(JSON.stringify({ content, chat_id: state.activeChatId }));
        msgInput.value = '';
        msgInput.style.height = 'auto';
    });
    msgInput.addEventListener('input', () => { msgInput.style.height = 'auto'; msgInput.style.height = Math.min(160, msgInput.scrollHeight) + 'px'; });

    // --- INITIALIZATION ---
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const tokenFromUrl = urlParams.get('token');
        const tokenFromStorage = localStorage.getItem('lingua_link_token');

        if (tokenFromUrl) {
            state.token = tokenFromUrl;
            localStorage.setItem('lingua_link_token', tokenFromUrl);
            window.history.replaceState({}, document.title, "/");
        } else if (tokenFromStorage) {
            state.token = tokenFromStorage;
        }
        initializeApp();
    };
    </script>
</body>
</html>

